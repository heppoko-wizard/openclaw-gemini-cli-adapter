name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build_and_release:
    name: Build and Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Package for Linux / macOS
        run: |
          PROJECT_NAME="openclaw-gemini-cli-adapter"
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          
          # 制作用ディレクトリ
          STAGE_DIR="dist/stage_linux"
          mkdir -p $STAGE_DIR/openclaw/$PROJECT_NAME
          
          # 1. ルートレベルのファイル
          cp setup.js install.sh $STAGE_DIR/openclaw/ 2>/dev/null || true
          cp README*.md LICENSE $STAGE_DIR/openclaw/ 2>/dev/null || true
          
          # 2. アダプタ本体のファイル
          cp -r src scripts public adapter.js mcp-server.mjs package.json start.sh installer-gui.js $STAGE_DIR/openclaw/$PROJECT_NAME/ 2>/dev/null || true
          
          # クリーンな.gemini設定を同梱
          mkdir -p $STAGE_DIR/openclaw/$PROJECT_NAME/src/.gemini
          echo '{"model":{"name":"auto-gemini-3"}}' > $STAGE_DIR/openclaw/$PROJECT_NAME/src/.gemini/settings.json
          
          # 不要ファイル・センシティブなデータを削除
          find $STAGE_DIR -name "*.log" -delete 2>/dev/null || true
          find $STAGE_DIR -name "oauth_creds.json" -delete 2>/dev/null || true
          find $STAGE_DIR -name "google_accounts.json" -delete 2>/dev/null || true
          find $STAGE_DIR -name "memory*" -delete 2>/dev/null || true
          
          # ZIP圧縮
          cd $STAGE_DIR
          zip -qr ../${PROJECT_NAME}-${TAG_NAME}-linux.zip openclaw/
          cd ../..
          
          # macOS用は同一内容をコピー
          cp dist/${PROJECT_NAME}-${TAG_NAME}-linux.zip dist/${PROJECT_NAME}-${TAG_NAME}-macos.zip

      - name: Package for Windows
        run: |
          PROJECT_NAME="openclaw-gemini-cli-adapter"
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          
          # 制作用ディレクトリ
          STAGE_DIR="dist/stage_win"
          mkdir -p $STAGE_DIR/openclaw/$PROJECT_NAME
          
          # 1. ルートレベルのファイル (Windows用は install.bat)
          cp setup.js install.bat $STAGE_DIR/openclaw/ 2>/dev/null || true
          cp README*.md LICENSE $STAGE_DIR/openclaw/ 2>/dev/null || true
          
          # 2. アダプタ本体のファイル (Windows用は start.sh を除外)
          cp -r src scripts public adapter.js mcp-server.mjs package.json installer-gui.js $STAGE_DIR/openclaw/$PROJECT_NAME/ 2>/dev/null || true
          
          # クリーンな.gemini設定を同梱
          mkdir -p $STAGE_DIR/openclaw/$PROJECT_NAME/src/.gemini
          echo '{"model":{"name":"auto-gemini-3"}}' > $STAGE_DIR/openclaw/$PROJECT_NAME/src/.gemini/settings.json
          
          # 不要ファイル・センシティブなデータを削除
          find $STAGE_DIR -name "*.log" -delete 2>/dev/null || true
          find $STAGE_DIR -name "oauth_creds.json" -delete 2>/dev/null || true
          find $STAGE_DIR -name "google_accounts.json" -delete 2>/dev/null || true
          find $STAGE_DIR -name "memory*" -delete 2>/dev/null || true
          
          # ZIP圧縮
          cd $STAGE_DIR
          zip -qr ../${PROJECT_NAME}-${TAG_NAME}-windows.zip openclaw/
          cd ../..


      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.zip
          draft: true
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
