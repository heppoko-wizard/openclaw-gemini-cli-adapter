<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Gemini CLI Adapter - Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(ellipse at top left, #0f2027, #203a43, #2c5364);
            min-height: 100vh;
        }

        .glass {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(148, 163, 184, 0.12);
        }

        .step {
            display: none !important;
        }

        .step.active {
            display: block !important;
        }

        /* Terminal */
        #terminal {
            font-family: 'Courier New', monospace;
            background: #020617;
            border: 1px solid #1e293b;
            height: 280px;
            overflow-y: auto;
            padding: 12px;
            border-radius: 8px;
        }

        .log-stdout {
            color: #94a3b8;
        }

        .log-stderr {
            color: #fbbf24;
        }

        .log-step_start {
            color: #60a5fa;
            font-weight: 600;
            padding-top: 6px;
        }

        .log-step_done {
            color: #34d399;
            font-weight: 600;
        }

        .log-step_error {
            color: #f87171;
            font-weight: 600;
        }

        .log-warning {
            color: #fbbf24;
        }

        .log-done {
            color: #a78bfa;
            font-weight: 700;
            padding-top: 8px;
            border-top: 1px solid #1e293b;
            margin-top: 8px;
        }

        .log-log {
            color: #64748b;
        }

        /* Progress bar */
        .progress-step {
            transition: all 0.3s;
        }

        .progress-step.done {
            background: #3b82f6;
        }

        .progress-step.active {
            background: #6366f1;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.6
            }
        }
    </style>
</head>

<body class="flex items-center justify-center p-4">

    <div class="glass w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col" style="height: 620px;">

        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-slate-700/50 bg-slate-900/60">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <h1 class="font-bold text-white">Gemini CLI Adapter Setup</h1>
            </div>
            <span id="step-indicator"
                class="text-xs font-semibold text-slate-400 bg-slate-800 px-3 py-1 rounded-full">Step 1 of 7</span>
        </div>

        <!-- Progress dots -->
        <div class="flex gap-1.5 px-6 pt-3">
            <div id="dot-1" class="h-1 flex-1 rounded-full progress-step active"></div>
            <div id="dot-2" class="h-1 flex-1 rounded-full progress-step bg-slate-700"></div>
            <div id="dot-3" class="h-1 flex-1 rounded-full progress-step bg-slate-700"></div>
            <div id="dot-4" class="h-1 flex-1 rounded-full progress-step bg-slate-700"></div>
            <div id="dot-5" class="h-1 flex-1 rounded-full progress-step bg-slate-700"></div>
            <div id="dot-6" class="h-1 flex-1 rounded-full progress-step bg-slate-700"></div>
            <div id="dot-7" class="h-1 flex-1 rounded-full progress-step bg-slate-700"></div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto px-6 py-5">

            <!-- Step 1: Welcome -->
            <div id="step-1" class="step active space-y-4">
                <h2 class="text-2xl font-bold text-white">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¸ã‚ˆã†ã“ã</h2>
                <p class="text-slate-300 text-sm leading-relaxed">ã“ã®ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã§ã€OpenClaw Gemini CLI ã‚¢ãƒ€ãƒ—ã‚¿ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚</p>

                <div class="bg-slate-800/60 rounded-xl border border-slate-700 p-4 space-y-3 mt-2">
                    <h3 class="text-sm font-semibold text-slate-300">ã‚·ã‚¹ãƒ†ãƒ ãƒã‚§ãƒƒã‚¯</h3>
                    <div id="status-openclaw" class="flex items-center gap-3 text-sm">
                        <div class="w-4 h-4 rounded-full bg-slate-600 animate-pulse shrink-0"></div>
                        <span class="text-slate-400">OpenClaw ã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</span>
                    </div>
                    <div id="status-built" class="flex items-center gap-3 text-sm">
                        <div class="w-4 h-4 rounded-full bg-slate-600 animate-pulse shrink-0"></div>
                        <span class="text-slate-400">ãƒ“ãƒ«ãƒ‰çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</span>
                    </div>
                    <div id="status-auth" class="flex items-center gap-3 text-sm">
                        <div class="w-4 h-4 rounded-full bg-slate-600 animate-pulse shrink-0"></div>
                        <span class="text-slate-400">Gemini èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</span>
                    </div>
                </div>

                <div id="status-notice"
                    class="hidden text-sm bg-amber-950/40 border border-amber-800/50 text-amber-300 p-3 rounded-lg">
                    <strong>ğŸ“‹ Notice:</strong> OpenClaw ãŒã¾ã ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã§è‡ªå‹•çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚
                </div>
            </div>

            <!-- Step 2: Architecture -->
            <div id="step-2" class="step space-y-4">
                <h2 class="text-2xl font-bold text-white">æ§‹æˆã®æ¦‚è¦</h2>
                <p class="text-slate-400 text-sm">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¨ã€èµ·å‹•å¾Œã®é€šä¿¡ãƒ•ãƒ­ãƒ¼ï¼š</p>

                <div class="space-y-2 mt-2">
                    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-3 flex gap-3 items-start">
                        <div
                            class="w-6 h-6 bg-blue-500/20 text-blue-400 rounded flex items-center justify-center shrink-0 mt-0.5 text-xs font-bold">
                            1</div>
                        <div>
                            <p class="text-white text-sm font-semibold">OpenClaw Gateway</p>
                            <p class="text-slate-400 text-xs mt-0.5">Telegram / WhatsApp ãªã©ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘ä»˜ã‘ã‚‹ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã€‚Port 18789
                            </p>
                        </div>
                    </div>
                    <div class="flex justify-center text-slate-600 text-xl">â†“</div>
                    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-3 flex gap-3 items-start">
                        <div
                            class="w-6 h-6 bg-indigo-500/20 text-indigo-400 rounded flex items-center justify-center shrink-0 mt-0.5 text-xs font-bold">
                            2</div>
                        <div>
                            <p class="text-white text-sm font-semibold">Gemini CLI Adapterï¼ˆæœ¬ãƒ„ãƒ¼ãƒ«ï¼‰</p>
                            <p class="text-slate-400 text-xs mt-0.5">OpenClaw ã¨ Gemini CLI é–“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä»²ä»‹ã€‚Port 3972</p>
                        </div>
                    </div>
                    <div class="flex justify-center text-slate-600 text-xl">â†“</div>
                    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-3 flex gap-3 items-start">
                        <div
                            class="w-6 h-6 bg-purple-500/20 text-purple-400 rounded flex items-center justify-center shrink-0 mt-0.5 text-xs font-bold">
                            3</div>
                        <div>
                            <p class="text-white text-sm font-semibold">Gemini CLI â†’ Google Gemini API</p>
                            <p class="text-slate-400 text-xs mt-0.5">ã‚¢ãƒ€ãƒ—ã‚¿å†…éƒ¨ã« <code
                                    class="text-blue-300 text-xs">src/.gemini</code> ã¨ã—ã¦å°‚ç”¨ãƒ»éš”é›¢ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</p>
                        </div>
                    </div>
                </div>

                <div class="text-xs text-slate-500 bg-slate-800/40 rounded-lg p-3 border border-slate-700/50">
                    âœ… æ—¢å­˜ã® Gemini CLI ãŒ PC ã«å…¥ã£ã¦ã„ã¦ã‚‚ã€è¨­å®šãƒ»èªè¨¼æƒ…å ±ã¯ã“ã“ã§ä¸Šæ›¸ãã•ã‚Œã¾ã›ã‚“ã€‚
                </div>
            </div>

            <!-- Step 3: Warning -->
            <div id="step-3" class="step space-y-4">
                <h2 class="text-2xl font-bold text-red-400 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd" />
                    </svg>
                    é‡è¦ãªè­¦å‘Š
                </h2>
                <div class="bg-red-950/30 border border-red-900/50 rounded-xl p-4 space-y-3">
                    <p class="text-white text-sm font-semibold">ã“ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯ã€ŒYOLO ãƒ¢ãƒ¼ãƒ‰ã€ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ã§ã™ã€‚</p>
                    <p class="text-red-200 text-sm">Gemini CLI ã¯ã€ã‚ãªãŸã® AI
                        ã¸ã®è¦æ±‚ã‚’æº€ãŸã™ãŸã‚ã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã‚„ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã‚’<strong>ç¢ºèªãªã—ã«è‡ªå‹•ã§è¡Œã„ã¾ã™</strong>ã€‚</p>
                    <div class="text-sm space-y-1">
                        <p class="font-semibold text-red-300">ä»¥ä¸‹ã®ç’°å¢ƒã§ã¯çµ¶å¯¾ã«å®Ÿè¡Œã—ãªã„ã§ãã ã•ã„ï¼š</p>
                        <ul class="list-disc pl-4 text-red-300/80 space-y-0.5 text-sm">
                            <li>æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ãƒ»é‡è¦ãªãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</li>
                            <li>ç ´å£Šçš„å¤‰æ›´ãŒè¨±å®¹ã§ããªã„ã‚·ã‚¹ãƒ†ãƒ </li>
                            <li>è¤‡æ•°äººãŒå…±æœ‰ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼</li>
                        </ul>
                    </div>
                </div>
                <label
                    class="flex items-center gap-3 p-3 bg-slate-800/60 rounded-xl border border-slate-700 cursor-pointer hover:bg-slate-800 transition">
                    <input id="agree-check" type="checkbox"
                        class="w-5 h-5 rounded text-blue-500 bg-slate-700 border-slate-600">
                    <span class="text-sm text-white font-medium">ãƒªã‚¹ã‚¯ã‚’ç†è§£ã—ã€åŒæ„ã—ã¦ç¶šè¡Œã—ã¾ã™</span>
                </label>
            </div>

            <!-- Step 4: Config -->
            <div id="step-4" class="step space-y-4">
                <h2 class="text-2xl font-bold text-white">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è¨­å®š</h2>
                <p class="text-slate-400 text-sm">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>

                <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input id="set-primary" type="checkbox" checked
                            class="w-5 h-5 rounded text-blue-500 bg-slate-700 border-slate-600 mt-0.5">
                        <div>
                            <p class="text-white font-semibold text-sm">Gemini ã‚¢ãƒ€ãƒ—ã‚¿ã‚’ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¢ãƒ‡ãƒ«ã«è¨­å®šã™ã‚‹</p>
                            <p class="text-slate-400 text-xs mt-1"><code>~/.openclaw/openclaw.json</code> ã®
                                <code>models.primary</code> ã‚’è‡ªå‹•è¨­å®šã—ã¾ã™ã€‚OpenClaw ã‹ã‚‰ Gemini ãŒé»˜èªã§ä½¿ã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                            </p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Step 5: Install -->
            <div id="step-5" class="step">
                <div class="h-full flex flex-col">
                    <h2 class="text-xl font-bold text-white mb-2">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œä¸­...</h2>
                    <p class="text-slate-400 text-sm mb-3">ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€è¨­å®šã‚’é©ç”¨ã—ã¦ã„ã¾ã™ã€‚å®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚</p>
                    <div id="terminal"></div>
                </div>
            </div>

            <!-- Step 6: Auth -->
            <div id="step-6" class="step space-y-4">
                <h2 class="text-2xl font-bold text-white">Gemini èªè¨¼</h2>
                <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4 text-sm text-slate-400 space-y-2">
                    <p>ğŸ”‘ ã“ã®èªè¨¼ã¯ <strong class="text-white">OpenClaw å°‚ç”¨ã®éš”é›¢ Gemini CLI</strong> ã«å¯¾ã—ã¦è¡Œã‚ã‚Œã¾ã™ï¼ˆ<code
                            class="text-blue-300 text-xs">src/.gemini</code> ã«ä¿å­˜ï¼‰ã€‚</p>
                    <p>æ—¢å­˜ã®ã‚·ã‚¹ãƒ†ãƒ ä¸Šã® Gemini CLI ã®è¨­å®šãƒ»èªè¨¼æƒ…å ±ã«ã¯ä¸€åˆ‡å½±éŸ¿ã—ã¾ã›ã‚“ã€‚</p>
                </div>

                <div id="auth-prompt" class="space-y-4">
                    <div class="bg-amber-950/30 border border-amber-700/50 rounded-xl p-4 space-y-3">
                        <p class="text-amber-300 text-sm font-semibold">âš ï¸ Gemini CLI ã®èªè¨¼ã¯ TTYï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰ãŒå¿…è¦ã§ã™</p>
                        <p class="text-amber-200/80 text-xs">ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã‹ã‚‰ç›´æ¥èµ·å‹•ã§ããªã„ãŸã‚ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ <strong>æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦</strong>
                            ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <div id="auth-cmd-box" class="bg-slate-900 border border-slate-600 rounded-xl p-4 space-y-2">
                        <p class="text-slate-400 text-xs mb-2">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š</p>
                        <code id="auth-cmd-text"
                            class="block text-blue-300 text-sm font-mono break-all bg-slate-800 p-3 rounded-lg">èª­ã¿è¾¼ã¿ä¸­...</code>
                        <button id="btn-copy-cmd" class="text-xs text-slate-400 hover:text-white transition mt-1">ğŸ“‹
                            ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <p class="text-slate-500 text-xs">ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ãŸå¾Œã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨è‡ªå‹•ã§ç¢ºèªã—ã¾ã™ã€‚</p>
                    <button id="btn-start-poll"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-semibold transition shadow-lg">
                        âœ… èªè¨¼å®Œäº†ã—ã¾ã—ãŸï¼ˆè‡ªå‹•ç¢ºèªé–‹å§‹ï¼‰
                    </button>
                    <button id="btn-skip-auth" class="w-full py-2 text-slate-400 hover:text-white text-sm transition">
                        ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¾Œã§æ‰‹å‹•ã§å®Ÿè¡Œï¼‰
                    </button>
                </div>

                <div id="auth-waiting" class="hidden" style="display:none">
                    <div class="flex flex-col items-center justify-center text-center space-y-4 py-4">
                        <div
                            class="w-14 h-14 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mx-auto">
                        </div>
                        <p class="text-white font-semibold">èªè¨¼ã‚’ç¢ºèªä¸­...</p>
                        <p class="text-slate-400 text-sm">è³‡æ ¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›£è¦–ã—ã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å¾Œã«è‡ªå‹•ã§æ¬¡ã¸é€²ã¿ã¾ã™ã€‚</p>
                    </div>
                </div>

                <div id="auth-done" class="hidden" style="display:none">
                    <div class="flex flex-col items-center justify-center text-center space-y-3 py-4">
                        <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <p class="text-xl font-bold text-white">èªè¨¼å®Œäº†ï¼</p>
                    </div>
                </div>
            </div>

            <!-- Step 7: Done -->
            <div id="step-7" class="step">
                <div class="flex flex-col items-center justify-center text-center py-6 space-y-5">
                    <div class="relative">
                        <div class="absolute inset-0 bg-blue-500/20 blur-2xl rounded-full"></div>
                        <div
                            class="relative w-24 h-24 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-xl border-4 border-slate-800">
                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-white">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼</h2>
                        <p class="text-slate-400 mt-1">ã‚¢ãƒ€ãƒ—ã‚¿ã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚</p>
                    </div>
                    <div class="bg-slate-800/60 border border-slate-700 rounded-xl p-4 text-left w-full space-y-2">
                        <p class="text-slate-200 text-sm font-semibold">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š</p>
                        <ol class="list-decimal pl-5 space-y-1.5 text-slate-400 text-sm">
                            <li>ã‚¢ãƒ€ãƒ—ã‚¿ã‚’èµ·å‹•: <code
                                    class="text-blue-300 bg-blue-900/30 px-1.5 rounded">./openclaw-gemini-cli-adapter/start.sh</code>
                            </li>
                            <li>OpenClaw ã‚’èµ·å‹•: <code
                                    class="text-blue-300 bg-blue-900/30 px-1.5 rounded">npm run start</code>
                            </li>
                            <li>Telegram ã§ AI ãƒœãƒƒãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ï¼</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div><!-- /content -->

        <!-- Footer -->
        <div id="footer"
            class="flex justify-between items-center px-6 py-4 border-t border-slate-700/50 bg-slate-900/60">
            <button id="btn-prev"
                class="px-4 py-2 text-sm text-slate-400 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition"
                disabled>â† æˆ»ã‚‹</button>
            <button id="btn-next"
                class="px-6 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded-lg text-sm font-semibold shadow-lg transition"
                disabled>æ¬¡ã¸ â†’</button>
        </div>
    </div>

    <script>
        (async function () {
            const TOTAL = 7;
            let step = 1;
            let state = {};
            let sse = null;
            let authPoll = null;

            const $ = id => document.getElementById(id);
            const btnPrev = $('btn-prev');
            const btnNext = $('btn-next');
            const indicator = $('step-indicator');
            const footer = $('footer');

            // --- Render step UI ---
            const render = () => {
                document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
                $(`step-${step}`).classList.add('active');
                indicator.textContent = `Step ${step} of ${TOTAL}`;

                // Update progress dots
                for (let i = 1; i <= TOTAL; i++) {
                    const dot = $(`dot-${i}`);
                    dot.className = 'h-1 flex-1 rounded-full progress-step';
                    if (i < step) dot.classList.add('done');
                    else if (i === step) dot.classList.add('active');
                    else dot.classList.add('bg-slate-700');
                }

                btnPrev.disabled = step === 1 || step === 5 || step === 7;
                btnNext.disabled = false;
                btnNext.textContent = step === TOTAL ? 'å®Œäº† & çµ‚äº†' : 'æ¬¡ã¸ â†’';
                footer.classList.remove('hidden');

                if (step === 3) {
                    btnNext.disabled = !$('agree-check').checked;
                }
                if (step === 5) {
                    btnNext.disabled = true;
                    footer.classList.add('opacity-50', 'pointer-events-none');
                    startInstall();
                }
                if (step === 6) {
                    footer.classList.add('hidden');
                }
            };

            // --- Terminal log ---
            const term = $('terminal');
            const addLog = (msg, type) => {
                if (!msg.trim()) return;
                const div = document.createElement('div');
                div.className = `log-${type}`;
                div.textContent = msg;
                term.appendChild(div);
                term.scrollTop = term.scrollHeight;
            };

            // --- Fetch status ---
            const fetchStatus = async () => {
                try {
                    const res = await fetch('/api/status');
                    state = await res.json();

                    const icon = (ok) => ok
                        ? `<span class="w-4 h-4 rounded-full bg-green-500 shrink-0"></span>`
                        : `<span class="w-4 h-4 rounded-full bg-amber-500 shrink-0"></span>`;

                    $('status-openclaw').innerHTML = `${icon(state.isOpenClawPresent)}
                <span class="${state.isOpenClawPresent ? 'text-green-400' : 'text-amber-400'} text-sm">
                    ${state.isOpenClawPresent ? 'OpenClaw ç¢ºèªæ¸ˆã¿' : 'OpenClaw æœªæ¤œå‡ºï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã§è‡ªå‹•å–å¾—ï¼‰'}
                </span>`;

                    $('status-built').innerHTML = `${icon(state.isBuilt)}
                <span class="${state.isBuilt ? 'text-green-400' : 'text-amber-400'} text-sm">
                    ${state.isBuilt ? 'ãƒ“ãƒ«ãƒ‰æ¸ˆã¿' : 'æœªãƒ“ãƒ«ãƒ‰ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã§è‡ªå‹•ãƒ“ãƒ«ãƒ‰ï¼‰'}
                </span>`;

                    $('status-auth').innerHTML = `${icon(state.hasAuth)}
                <span class="${state.hasAuth ? 'text-green-400' : 'text-slate-400'} text-sm">
                    ${state.hasAuth ? 'Gemini èªè¨¼æ¸ˆã¿' : 'æœªèªè¨¼ï¼ˆå¾Œã®æ‰‹é †ã§èªè¨¼ã—ã¾ã™ï¼‰'}
                </span>`;

                    if (!state.isOpenClawPresent) {
                        $('status-notice').classList.remove('hidden');
                    }
                    btnNext.disabled = false;
                    showAuthCommand(); // Step 6 ç”¨ã‚³ãƒãƒ³ãƒ‰è¡¨ç¤º
                } catch (e) {
                    console.error('Status fetch failed', e);
                    btnNext.disabled = false; // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
                }
            };

            // --- Start installation ---
            const startInstall = () => {
                if (sse) sse.close();
                sse = new EventSource('/api/logs');
                sse.onmessage = e => {
                    const d = JSON.parse(e.data);
                    addLog(d.message, d.type);
                    if (d.type === 'done') {
                        sse.close();
                        footer.classList.remove('opacity-50', 'pointer-events-none');
                        btnNext.disabled = false;
                        btnNext.classList.add('animate-pulse');
                    }
                };
                sse.onerror = () => { };

                const setPrimary = $('set-primary').checked;
                fetch('/api/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ setPrimary })
                }).catch(e => addLog(`Request error: ${e.message}`, 'step_error'));
            };

            // --- Auth step: show command and setup polling ---
            const startAuthPolling = () => {
                $('auth-prompt').style.display = 'none';
                $('auth-waiting').style.display = 'block';

                authPoll = setInterval(async () => {
                    try {
                        const r = await fetch('/api/auth/status');
                        const d = await r.json();
                        if (d.hasAuth) {
                            clearInterval(authPoll);
                            $('auth-waiting').style.display = 'none';
                            $('auth-done').style.display = 'block';
                            setTimeout(() => { step++; render(); }, 2000);
                        }
                    } catch (e) { }
                }, 2000);
            };

            // Show the gemini login command (fetched from status)
            const showAuthCommand = () => {
                const geminiPath = state.pluginDir
                    ? `GEMINI_CLI_HOME="${state.pluginDir}/src/.gemini" "${state.pluginDir}/node_modules/.bin/gemini" login`
                    : 'GEMINI_CLI_HOME="./openclaw-gemini-cli-adapter/src/.gemini" "./openclaw-gemini-cli-adapter/node_modules/.bin/gemini" login';
                const cmdEl = $('auth-cmd-text');
                if (cmdEl) cmdEl.textContent = geminiPath;
            };

            $('btn-copy-cmd') && $('btn-copy-cmd').addEventListener('click', () => {
                const text = $('auth-cmd-text')?.textContent || '';
                navigator.clipboard.writeText(text).then(() => {
                    $('btn-copy-cmd').textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                    setTimeout(() => { $('btn-copy-cmd').textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼'; }, 2000);
                });
            });

            $('btn-start-poll') && $('btn-start-poll').addEventListener('click', startAuthPolling);

            $('btn-skip-auth').addEventListener('click', () => {
                if (authPoll) clearInterval(authPoll);
                step++;
                render();
            });

            // --- Agree checkbox ---
            $('agree-check').addEventListener('change', e => {
                if (step === 3) btnNext.disabled = !e.target.checked;
            });

            // --- Navigation ---
            btnPrev.addEventListener('click', () => {
                if (step > 1) { step--; render(); }
            });

            btnNext.addEventListener('click', () => {
                if (step === TOTAL) {
                    btnNext.disabled = true;
                    btnNext.textContent = 'çµ‚äº†ä¸­...';
                    fetch('/api/exit', { method: 'POST' }).catch(() => { });
                    window.close();
                    document.body.innerHTML = `<div class="min-h-screen flex items-center justify-center text-center">
                <div><h1 class="text-2xl font-bold text-white mb-2">ã“ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¦æ§‹ã„ã¾ã›ã‚“</h1>
                <p class="text-slate-400">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã‚µãƒ¼ãƒãƒ¼ãŒã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã—ã¾ã—ãŸã€‚</p></div></div>`;
                    return;
                }

                step++;
                // èªè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆèªè¨¼æ¸ˆã¿ã®å ´åˆï¼‰
                if (step === 6 && state.hasAuth) step++;
                render();
            });

            // --- Init ---
            btnNext.disabled = true; // Wait for status fetch
            render();
            await fetchStatus();

        })();
    </script>
</body>

</html>
