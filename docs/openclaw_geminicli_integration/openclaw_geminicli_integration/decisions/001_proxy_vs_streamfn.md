# ADR-001: プロキシサーバー（Adapter）方式の選定

- **日付**: 2026-02-21
- **ステータス**: 採用
- **関連**: なし

## 背景（Context）

OpenClawの機能（TelegramやWebUIを通したフロントエンド機能と履歴の自動Pruning）を維持しつつ、Google公式のCLIツールである `gemini-cli` を推論エンジンとして連携させたい。
当初、OpenClawが内蔵している直接LLMを呼び出す機構（`StreamFn` など）を直接改造してGemini CLIを呼び出す方法を検討した。

## 検討した選択肢（Options）

### 案A: OpenClaw本体（TypeScript）の直接改造
- **概要**: OpenClawのソースコード内に `runCliAgent` 的な関数を新設し、直接Gemini CLIプロセスを叩く。
- **利点**: 中間サーバーが不要になり構成がシンプルになる。
- **欠点**: OpenClawは活発に開発されており、本体に手を入れると将来のアップデートへの追従（マージコンフリクト解決）が極めて困難になる。また、ビルド環境の維持コストが高い。

### 案B: OpenAI互換の独立したHTTPアダプタ（本案）
- **概要**: OpenClawからは標準の `openai-completions` APIプロバイダとして見せかけ、そのリクエストを受け取ってGemini CLIを呼び出し、ストリーミングで返すNode.jsの軽量HTTPサーバー（`adapter.js`）を横に立てる。
- **利点**: OpenClaw本体は無改造（設定変更のみ）で済む。疎結合のためメンテナンスが容易。
- **欠点**: プロセスが2つ（GatewayとAdapter）起動することになり、運用管理の手間が微増する。

## 決定（Decision）

**案B（独立したHTTPアダプタ方式）を採用する。**
OSSであるOpenClawの恩恵を受け続けるためには、本体のライフサイクルと切り離した「疎結合なアダプタ」にするのが最も持続可能であると判断したため。

## 結果（Consequences）

- `openclaw-gemini-cli-adapter/` という独立したディレクトリにアダプタが実装された。
- OpenClawのアップデート影響を最小限に抑えつつ、Gemini CLIの全機能（ローカルブラウザ操作等含む）をTelegram等から呼び出せる基盤が整った。
- 代償として、HTTP通信上の「コンテキスト（会話履歴）の多重管理」という泥沼の課題を引き起こすこととなった（次ADRにて詳述）。

## 参考資料
- 該当チャットログ: `2109bafb-6346-4586-abf6-83638a72bc8c` (初期構想フェーズ)
