# OpenClawにおけるエージェント呼び出しとコンテキスト管理の仕組み

ご質問いただいた「OpenClawのエージェント呼び出しメカニズム」と「プロンプト・スキルの振り分け」について、ソースコードベースで調査した結果をご報告します。

## 1. 呼び出し元（トリガー）の種類
ご認識の通り、OpenClawがエージェント（今回であればGemini CLIのアダプタ）を呼び出すトリガーは大きく以下の3種類に限定されています。

1. **ユーザーからの入力 (`auto-reply` デーモン / webhook・ポーリング)**
   - ユーザーからのダイレクトメッセージやメンションがあった際の標準的な呼び出しです。
   - [src/auto-reply/reply/agent-runner-execution.ts](file:///home/heppo/.gemini/antigravity/playground/emerald-copernicus/openclaw/src/auto-reply/reply/agent-runner-execution.ts) などを経由します。

2. **Heartbeat（定期的な自律思考）**
   - OpenClawが一定間隔（15分や30分など）でエージェントを文字通り「起こす」ためのトリガーです。ユーザー入力がなくても自律的にキューの処理や情報収集を行わせるためのものです。
   - 特殊なプロンプト（"Heartbeat" 用の合言葉）とともに呼び出されます。

3. **Cronジョブ / Isolated Agent（完全なバックグラウンドタスク）**
   - [src/cron/isolated-agent/run.ts](file:///home/heppo/.gemini/antigravity/playground/emerald-copernicus/openclaw/src/cron/isolated-agent/run.ts) などから呼び出されます。
   - スケジュールされた定期タスク（例：朝のニュース要約、ログのクリーンアップなど）を独立したコンテキストで実行するためのトリガーです。

## 2. コンテキスト（プロンプト・スキル）の振り分けについて

結論から言うと、**「状況に応じたプロンプトの出し分け」や「スキル・ツールの選定」は、アダプタ側ではなく、すべて OpenClaw本体（Node.js側のコアシステム）で集中的に処理（実装）されています。** アダプタは、それを受け取ってGemini CLIに通訳するだけの「土管（あるいは封筒）」の役割に徹しています。

具体的なフローは以下の通りです：

### A. OpenClawコアでのビルド処理 ([src/agents/cli-runner.ts](file:///home/heppo/.gemini/antigravity/playground/emerald-copernicus/openclaw/src/agents/cli-runner.ts) 等)
OpenClawは呼び出し元（ユーザー入力なのか、Cronなのか）に応じて、以下の要素を動的に構築します。

- **`requires` によるスキルフィルタリング**: 実行時点でのOS、ユーザー権限、設定などを評価し、現在使えるスキル（`coding-agent`, `skill-creator`など）のパスリストを生成します。
- **動的システムプロンプトの構築 ([buildAgentSystemPrompt](file:///home/heppo/.gemini/antigravity/playground/emerald-copernicus/openclaw/src/agents/system-prompt.ts#169-640))**: 
  - 現在時刻、使用モデル
  - `MEMORY.md` への参照指示
  - 音声(TTS)のヒントや利用可能なツールリスト
  - 呼び出し元に応じた特殊指示（Cron用の軽量版プロンプトか、メインエージェント用のフルプロンプトか）

これらを1つの巨大なMarkdown文字列として組み上げます。

### B. アダプタへの引き渡し
OpenClawは、組み上げたプロンプトを環境変数または引数（我々が設定した `{allowedSkillsPaths}` やプレースホルダ）の形でアダプタ（[adapter.js](file:///home/heppo/GoogleDrive_Sync/ai_tools/gemini-autocore/adapter/gemini-openclaw-adapter.js) / [adapter-template.md](file:///home/heppo/.gemini/antigravity/playground/emerald-copernicus/openclaw/gemini-backend/adapter-template.md)）に渡します。

### C. アダプタでの処理（テンプレート置換）
今回私たちが作成した [adapter-template.md](file:///home/heppo/.gemini/antigravity/playground/emerald-copernicus/openclaw/gemini-backend/adapter-template.md) 内にある `{{PROVIDED_SYSTEM_PROMPT}}` という部分に、上記の **「OpenClawが状況に応じて頑張って組み立てた動的な長文プロンプト」がそのままガバッと流し込まれます**。

また、スキルについてもOpenClawが計算した `{allowedSkillsPaths}` のリストを受け取り、アダプタはそのリスト通りのシンボリックリンクを一時作成してGemini CLIに見せるだけです。

---

## 結論
「呼び出しの状況に応じたプロンプトや与えるコンテキストやスキルの振り分け」の**頭脳（ロジック）はすべてOpenClaw本体**が担っています。
アダプタの役割は、**「OpenClawが出した結論（このプロンプトで、このスキルセットで戦え）を、Gemini CLIが理解できる形（ホームディレクトリの偽装やMarkdownへの結合）に翻訳してあげること」**に特化して設計されています。
