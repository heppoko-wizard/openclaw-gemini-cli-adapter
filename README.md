# OpenClaw Gemini CLI Adapter (gemini-cli-claw)

[OpenClaw](https://github.com/mariozechner/openclaw) のバックエンド推論エンジンとして、Google公式の [Gemini CLI](https://github.com/google/gemini-cli) を直接接続するためのアダプタツールです。
Gemini CLI そのものに「自立駆動型エージェント」としての側面を与え、OpenClawの強力な自律性とスキル群をGemini CLIから直接扱えるようにします。

## 開発の背景

近年、Gemini CLIのGoogle OAuth認証ロジックを非公式に流用したサードパーティツールの流行により、ユーザーのアカウントが停止される事例が多数報告されています。
本ツールはこのような「認証の流用」を行わず、**「OpenClawのシステムが、ユーザーのローカル環境にある正規のGemini CLIコマンドを直接起動して操作する」** というアーキテクチャを採用することで、アカウントリスクを回避しつつ安全にエージェント環境を構築することを目的に制作されました。

## 機能・メリット

*   **完全無料でのエージェント体験**: APIキーは不要です。Googleアカウントで `gemini login` を行うだけで、無料で自律駆動型エージェントを利用できます。
*   **検索グラウンディング対応**: Gemini CLIが持つ「Google検索グラウンディング」機能がそのまま利用できるため、無料で最新情報にアクセスした推論が可能です。
*   **マルチモーダル完全対応**: 画像などのファイルを直接読み込ませての推論に対応しています。
*   **動的MCPサーバーのネイティブ統合**: OpenClawの強力なツール群（`message`, `tts`, `web_search`, `sessions_spawn` など）を、Gemini CLIがネイティブに認識できる **MCP (Model Context Protocol)** サーバー形式で自動マッピングし提供します。これにより完全な相互運用環境が実現されています。
*   **OpenClawの基盤スキル活用**: OpenClawが持つ「Heartbeat（自律鼓動）」やファイルシステムアクセス、スケジューリングなどのシステムがGemini CLIでそのまま動作するよう設計されています。
*   **独立した安全な隔離環境**: 実行時に独自のセッションと分離されたテンポラリ環境（`GEMINI_CLI_HOME`）を構築し、許可されたスキルのみを安全に連携させます。

## 必要条件
*   コマンドライン環境と基本的なツール (`git`, `curl` 等)
*   Googleアカウント（セットアップ時にブラウザでのログインが必要です）
*   *※ Node.js(v18+) や OpenClaw本体 は、インストーラーが不足を検知し自動的にダウンロード・設定を行います。*

## インストール (クイックスタート)

もっとも簡単な方法は、同梱されている自動セットアップスクリプトを実行することです。
このスクリプトは、環境チェック、OpenClaw本体のクローン・ビルド、アダプタの登録(`openclaw.json`)、そしてGemini APIの認証(`gemini login`)の全てを全自動で行います。

**【⚠️ インストール時の重要事項】**
*   **インストール時間の長さ:** OpenClaw本体のビルド（TypeScriptコンパイル等）や、連携専用のGemini CLIを含むnpmパッケージのダウンロードをすべて一括で行うため、環境によっては**完了までにかなりの時間（数分以上）がかかります。** ターミナルが止まっているように見えても、完了メッセージが出るまで閉じずにお待ちください。
*   **専用のGemini CLI環境:** このインストーラーはシステム環境を汚染しないよう、グローバルではなく本ツール専用の `gemini-cli` をこのリポジトリ直下(`node_modules`)に直接ダウンロードして隔離利用します。

### 実行手順

**既にOpenClawをご利用中（インストール済み）の方:**
必ず、ダウンロードしたこの `gemini-cli-claw` フォルダごと、既存の `openclaw` フォルダの**直下**に移動させてからインストールスクリプトを実行してください。
（配置例: `openclaw/gemini-cli-claw/install.bat` となるように配置する）

**まだOpenClawを導入していない一番最初の方:**
任意のフォルダで以下のスクリプトを実行すれば、インストーラーが自動的にOpenClaw本体をダウンロード(git clone)して構築まで行います。

**Linux / macOS:**
```bash
# このリポジトリフォルダに移動して以下を実行
chmod +x install.sh
./install.sh
```

**Windows:**
エクスプローラーからこのフォルダ内の `install.bat` をダブルクリックするか、コマンドプロンプトで以下を実行してください。
```cmd
install.bat
```

## 使い方

OpenClawの設定 (`openclaw.json`) にて、メインの推論エンジンをGeminiアダプタに切り替えて使用します。

```json
"models": {
  "primary": "gemini-adapter/default"
}
```

設定後、通常通りOpenClawのCLIやTelegram/Discordインターフェースからメッセージを送信すると、バックエンドでGemini CLIが起動し、応答を返します。

## アーキテクチャ

本アダプタは、以下の2つの処理に徹した「翻訳層」として動作します。Gemini CLI本体やOpenClaw本体（TypeScriptのビルド）に直接手を加える面倒な作業は発生しません。

1. **スキルの隔離**:
   OpenClawから渡される「使用許可されたスキル」だけをシンボリックリンクでGemini側に提供し、Gemini CLIの暴走を防ぎます。
2. **システムプロンプトの中継**:
   OpenClawが動的生成するコンテキスト（`<system>...</system>`）を抽出し、そのままGemini CLIの `GEMINI_SYSTEM_MD` としてセットし、ネイティブなエージェントワークフローを成立させます。

## 制限事項・トラブルシューティング

*   **APIの利用制限 (Rate Limit)**: 無料のGemini APIを利用している場合、短時間の過度なリクエストにより制限（429 Too Many Requests）に引っかかる場合があります。
*   **認証の有効期限**: Gemini CLIのログインセッションが切れた場合は、再度当該ディレクトリ（`gemini-cli-claw`内）で `npx gemini login` を実行して再認証を行ってください。
*   **使用不能なツールと理由**: 以下のツールは現在、競合回避や構成上の制約により除外されています。
    *   **ファイル操作・実行系 (`read`, `write`, `edit`, `exec`, `bash`, `process`)**: Gemini CLI 標準ツール（ホスト権限）と機能が重複し、名称が競合するため除外されています。
    *   **ブラウザ (`browser`)**: 現在の構成では正常に動作しないため除外されています（詳細な原因は未調査）。Playwright などを用いて MCP ツールを自作することで機能を補完可能です。
    *   **ヒント**: Gemini 標準の `google_web_search` は、検索からページ閲覧（グラウンディング）までを一括で行えるため、OpenClaw の `web_search` / `web_fetch` / `browser` の大部分を強力に代替できます。

## 開発ロードマップ (Roadmap)

現在、このアダプタはコア機能（安全なアクセス、コンテキスト中継、基本環境の隔離）に特化して安定稼働していますが、アーキテクチャ上の致命的な欠落（コンテキスト剪定の乖離など）に関する詳細は [KNOWN_ISSUES.md](KNOWN_ISSUES.md) を参照してください。

今後の主な機能追加・改修として以下を計画しています。

*   **ストリーミング出力への対応:** 
    現在はJSON形式の出力を用いたセッションIDの確実な取得のため、処理が完全に終わってからOpenClawへ結果を一括返却する同期的な動きになっています。これをストリーミングで徐々に文字を出力し、よりネイティブな使用感に近づける改修を検討しています。
*   **マルチセッションでの高度なコンテキスト剪定 (Pruning):**
    トークン上限に達した際の履歴のガベージコレクションについて、Gemini CLI側の履歴とOpenClaw側のコンテキストのズレを完璧に同期するための高度な状態管理。

## アンインストール

このアダプタを削除して元のOpenClawの状態に戻すには以下の手順を行ってください。

1. `~/.openclaw/openclaw.json` を開き、`models.primary` を元の値（例: `anthropic-messages/claude-sonnet-3-5` など）に戻します。
2. `openclaw.json` の `cliBackends` に追加された `"gemini-adapter"` のブロックを削除します。
3. リポジトリフォルダ (`gemini-cli-claw`) を削除します。システム全体（グローバル）への影響は一切残らず、クリーンに削除されます。
