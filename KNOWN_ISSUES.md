# 未解決のアーキテクチャ課題と制限事項 (Known Issues)

OpenClawとGemini CLIを接続する本アダプタ (`gemini-cli-claw`) において、現状の設計上、完全には引き出せていないOpenClaw本来の機能や、長期運用・自律稼働において致命的となり得る3つのクリティカルな課題をここに記録します。

## ✅ 1. 実行の同期的ロックとタイムアウト問題（**解決済み**）

**対象モジュール:** ~~`adapter.js`~~ → `src/server.js`, `src/streaming.js`, `src/runner-pool.js`

旧実装では Gemini CLI を呼び出す際に Node.js の `spawnSync`（同期実行処理）を用いていましたが、現在は非同期ストリーミング・ Runner Pool 方式に完全移行しました。

*   **同期ロックの解消**: OpenClaw 側に出力を即時ストリームするリアルタイム SSE 実装（`src/streaming.js` + `src/runner-pool.js`）により解決。
*   **タイムアウト問題の解消**: Abort 機能（`res.on('close')` フック → `SIGTERM`/`SIGKILL`）の実装により解決。クライアントが `/stop` で切断されると、Gemini CLI プロセスが即座に安全に破棄される。

## 2. コンテキスト剪定（Pruning）の完全な乖離

**対象モジュール:** `src/server.js` (セッション管理) および Gemini CLI本体

OpenClawは元来、トークン上限に近づいた際に古い記憶を圧縮・要約してコンテキストウィンドウを維持する「賢いガベージコレクション（Pruning）機能」を持っています。しかし、本アダプタでは Gemini CLI の `--resume <セッションID>` フラグを利用して対話を継続しています。

*   **影響:**
    過去の会話履歴の管理を、Gemini CLI本体の内部データベース（`~/.gemini/history`）に完全に丸投げしています。
*   **致命的リスク:**
    OpenClaw本体がどれだけ賢くコンテキストを圧縮してシステムプロンプトに注入しても、Gemini側はデータベース内に蓄積された元の生の会話履歴を無限に読み込み続けます。Heartbeatによる定期自律稼働や、常駐チャットとして使い続けた場合、いずれ遠くない未来に必ずGemini APIのトークン上限（最大200万トークン）を突破し、APIエラーで機能停止に陥ります。
*   **解決方針案:**
    Geminiの `--resume` 機能による自動履歴管理を廃止し、本アダプタを毎回ステートレスな一度きりの呼び出しとして構成した上で、**毎回OpenClawが計算した最適なコンテキスト履歴を、すべてプロンプトに文字列として手動で差し込んで渡す**という、完全な「操り人形化（プロキシ化）」の改修が必要です。

## 3. MCPツールの途中経過（Stream/onUpdate）とキャンセルの喪失

**対象モジュール:** `mcp-server.mjs`

OpenClawのネイティブツール機能は、「長時間の実行中に、今何をしているかの進捗やログを `onUpdate` コールバックでリアルタイムに返す」能力や、「不要になった処理を `AbortSignal` で強制中断する」能力を備えています。

*   **影響:**
    `mcp-server.mjs` の現在のディスパッチ実装（137行目付近）では、元ツールから送られてくる `onUpdate` の進捗ログを、単なる `console.error` として虚空（Gemini CLIの不可視領域）に捨ててしまっています。
*   **致命的リスク:**
    Gemini側からは、ツールが延々と無言で動いているようにしか見えず、「途中のエラーログに気づいて自らリカバリー操作を行う」といった高度な自律的判断ができません。また、キャンセルのシグナルを送る機構も未実装なため、ツールが暴走した場合の中断も不可能です。
*   **解決方針案:**
    Model Context Protocol (MCP) の仕様に沿って、進行中状況を通知するストリーム機能の実装、またはエラーや途中経過を段階的に返すイベントフックの構築が必要です。
    > **【検証結果 (2024/02時点)】**
    > 実際に `mcp-server.mjs` にて `_meta.progressToken` を検知して `notifications/progress` を返す実装をテストしましたが、**現在の Gemini CLI は MCPツール呼び出し時に `progressToken` を一切送信しない（進捗管理プロトコルに未対応である）** ことが判明しました。そのため、この問題の根本解決には「Gemini CLI本体側のアップデート」または「途中経過を別ツール（中間ファイル等）経由で手動ポーリングさせる特殊なプロンプト設計」を待つ必要があります。
