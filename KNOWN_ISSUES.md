# 未解決のアーキテクチャ課題と制限事項 (Known Issues)

OpenClawとGemini CLIを接続する本アダプタ (`gemini-cli-claw`) において、現状の設計上、完全には引き出せていないOpenClaw本来の機能や、長期運用・自律稼働において致命的となり得る3つのクリティカルな課題をここに記録します。

## ✅ 1. 実行の同期的ロックとタイムアウト問題（**解決済み**）

**対象モジュール:** ~~`adapter.js`~~ → `src/server.js`, `src/streaming.js`, `src/runner-pool.js`

旧実装では Gemini CLI を呼び出す際に Node.js の `spawnSync`（同期実行処理）を用いていましたが、現在は非同期ストリーミング・ Runner Pool 方式に完全移行しました。

*   **同期ロックの解消**: OpenClaw 側に出力を即時ストリームするリアルタイム SSE 実装（`src/streaming.js` + `src/runner-pool.js`）により解決。
*   **タイムアウト問題の解消**: Abort 機能（`res.on('close')` フック → `SIGTERM`/`SIGKILL`）の実装により解決。クライアントが `/stop` で切断されると、Gemini CLI プロセスが即座に安全に破棄される。

## ✅ 2. コンテキスト剪定（Pruning）の完全な乖離（**解決済み**）

**対象モジュール:** `src/server.js`, `src/session.js`

過去のアーキテクチャでは、Gemini CLI の `--resume <セッションID>` フラグを利用して対話を継続していたため、トークン管理をGeminiの内部データベースに依存し、OpenClaw側のコンテキスト剪定（Pruning）が反映されないという致命的な問題がありました。

*   **完全なプロキシ化による解決**: 現在は `--resume` によるGemini側での履歴の自動継続を廃止しました。
*   **ステートレスな直接注入**: 毎ターン、OpenClawによって最適に計算・剪定された履歴（`messages`）を受け取り、アダプター側で `resumedSessionData` 構造体に変換。Runner Pool を通じて直接 Gemini CLI プロセスのメモリに注入する「操り人形化（完全なプロキシ化）」を実現したため、このトークン上限突破問題は根本から解決しています。

## 3. MCPツールの途中経過通知（Stream/onUpdate）の欠如（**※実用上は軽微な制限**）

**対象モジュール:** `mcp-server.mjs`

OpenClawのネイティブツール機能は長時間の実行中に、進捗ログを `onUpdate` でリアルタイムに返す能力を備えていますが、現在の Gemini CLI の MCP クライアント実装はこのプロトコル（`progressToken`）に対応していません。

*   **影響:**
    ツールから送られてくる `onUpdate` の進捗ログは単なるコンソール出力として破棄され、Geminiには最終結果（完了またはエラー）のみが通知されます。
*   **なぜ実用上問題にならないか（致命的リスクの解消）:**
    以前は「ツールが暴走した際にキャンセル機構がないためシステム全体が死ぬ」という致命的リスクが懸念されていました。しかし、クライアント切断を検知してプロセスごと強制破棄する **Abort機能（`/stop`）が実装されたため、ユーザー側でいつでも安全に暴走を断ち切れる** ようになりました。
    また、ブラウザツールなどの複雑なツールでも、最終的な `tool_result` に成功時のDOMやエラー詳細が含まれて返るため、Geminiの自律的推論（リカバリー操作など）は中間ログがなくても十分に機能することが運用テストで確認されています。
*   **根本解決への期待:**
    将来的に Gemini CLI 本体や MCP SDK が Progress API や Cancellation API にフル対応すれば、ツール実行中のより高度な自律的インタラクション（途中経過を見て自己中断するなど）が可能になります。
    > **【検証結果 (2024/02時点)】**
    > 実際に `mcp-server.mjs` にて `_meta.progressToken` を検知して `notifications/progress` を返す実装をテストしましたが、**現在の Gemini CLI は MCPツール呼び出し時に `progressToken` を一切送信しない（進捗管理プロトコルに未対応である）** ことが判明しました。そのため、この問題の根本解決には「Gemini CLI本体側のアップデート」または「途中経過を別ツール（中間ファイル等）経由で手動ポーリングさせる特殊なプロンプト設計」を待つ必要があります。
